# 🔧 Upbit AutoProfit Bot v5.7 - 긴급 수정 완료

## 📋 버전 정보
- **버전**: v5.7 (2026-02-11)
- **커밋**: 2bc95f6
- **저장소**: https://github.com/lee-jungkil/Lj
- **이전 버전**: v5.6 → v5.7

---

## 🔴 스크린샷 오류 분석

### 1. 거래 로그 오류 ✅
```
[ERROR] 거래 로그 저장 실패: [WinError 183] 
파일이 이미 있으므로 만들 수 없습니다: 
'trading_logs\\trade_20260211.json.backup'
```

**해결**: 기존 백업 파일 자동 삭제 후 재생성

### 2. 기존 코인 매도 정책 미반영 ✅
```
요청: 투자금 + 이익분만 매도 (원금 보호)
```

**해결**: HoldingProtector 매도 정책 완전 개편

---

## ✅ 핵심 변경사항

### 1. **기존 코인 매도 정책** (v5.7 핵심) 🆕

#### Before (v5.6)
```python
# 전체 매도 가능
보유: BTC 0.001개 (원금)
추가 매수: 0.0005개 (투자금)
→ 매도: 0.0015개 전체 가능 ❌
```

#### After (v5.7) ⭐
```python
# 투자금 + 이익분만 매도
보유: BTC 0.001개 (원금) ← 절대 보호 ❌
추가 매수: 0.0005개 (투자금) ← 매도 가능 ✅
이익: +10% = 0.00005개 ← 매도 가능 ✅

매도 가능: 0.00055개 (투자금 + 이익)
매도 불가: 0.001개 (원금 보호)
```

---

## 📊 매도 정책 상세 설명

### 정책 규칙

#### 1. **원금 보호** (기존 보유)
```
상황: BTC 0.001개 기존 보유
→ 이 수량은 절대 매도 불가 ❌
→ 봇이 건드리지 않음
```

#### 2. **투자금 매도 가능** (봇 매수분)
```
상황: 봇이 BTC 0.0005개 추가 매수
→ 이 수량은 매도 가능 ✅
→ 손실이어도 매도 허용
```

#### 3. **이익분 매도 가능** (수익 발생 시)
```
상황: 투자금 0.0005개가 +10% 수익
→ 이익분 0.00005개 추가 매도 가능 ✅
→ 총 매도 가능: 0.00055개
```

### 계산 로직

```python
# 매도 가능 수량 계산

1. 기본:
   매도 가능 = 실제 보유 - 원금(기존 보유)

2. 이익 발생 시:
   이익률 = (현재가 - 투자 평균가) / 투자 평균가
   이익분 = 투자금 × 이익률
   매도 가능 = 투자금 + 이익분

3. 안전장치:
   매도 가능 = min(계산값, 실제 보유 - 원금)
```

---

## 💰 실전 예시

### 예시 1: 수익 발생
```
초기 상태:
- 원금: BTC 0.002개 (평균 48,000,000원)
- KRW 잔고: 500,000원

봇 동작:
1. BTC 추가 매수: 0.0005개 (50,000,000원)
2. 가격 상승: 50,000,000 → 55,000,000원 (+10%)

매도 가능 계산:
- 투자금: 0.0005개 ✅
- 이익분: 0.0005 × 10% = 0.00005개 ✅
- 총 매도 가능: 0.00055개
- 원금 보호: 0.002개 ❌

매도 시:
- 매도: 0.00055개 (550,000원)
- 수익: +50,000원 (+10%)
- 남은 원금: 0.002개 (그대로 보존)
```

### 예시 2: 손실 발생
```
초기 상태:
- 원금: ETH 0.1개 (평균 3,000,000원)
- KRW 잔고: 500,000원

봇 동작:
1. ETH 추가 매수: 0.05개 (3,200,000원)
2. 가격 하락: 3,200,000 → 3,000,000원 (-6.25%)

매도 가능 계산:
- 투자금: 0.05개 ✅
- 이익분: 없음 (손실)
- 총 매도 가능: 0.05개
- 원금 보호: 0.1개 ❌

매도 시:
- 매도: 0.05개 (150,000원)
- 손실: -10,000원 (-6.25%)
- 남은 원금: 0.1개 (그대로 보존)
```

### 예시 3: 여러 번 매수
```
초기 상태:
- 원금: SOL 1개 (평균 150,000원)

봇 동작:
1. 추가 매수 1차: 0.5개 (160,000원)
2. 추가 매수 2차: 0.3개 (165,000원)
3. 가격 상승: 165,000 → 180,000원 (+9%)

매도 가능 계산:
- 총 투자금: 0.8개 (평균 161,875원)
- 이익분: 0.8 × 9% = 0.072개
- 총 매도 가능: 0.872개
- 원금 보호: 1개 ❌

매도 시:
- 매도: 0.872개 (156,960원)
- 수익: +27,560원 (+21%)
- 남은 원금: 1개 (그대로 보존)
```

---

## 🔧 로그 오류 수정

### 문제
```python
# WinError 183: 백업 파일이 이미 존재
backup_path.rename(new_backup)  # ❌ 실패
```

### 해결
```python
# 기존 백업 삭제 후 생성
if backup_path.exists():
    backup_path.unlink()  # 기존 삭제
backup_path.rename(new_backup)  # ✅ 성공
```

---

## 📂 수정된 파일

### 1. `src/utils/holding_protector.py` (핵심)
```python
def calculate_sellable_amount(
    self, 
    ticker: str,
    current_price: float = 0.0,  # 🆕 이익 계산용
    upbit_api=None
) -> tuple[float, str]:
    """
    v5.7 정책:
    - 원금(기존 보유): 절대 매도 불가
    - 투자금(봇 매수): 매도 가능
    - 이익분: 매도 가능
    """
    # 원금 보호
    existing_amount = self.get_existing_amount(ticker)
    
    # 투자금
    bot_amount = self.bot_positions[ticker].bot_amount
    bot_avg_price = self.bot_positions[ticker].bot_avg_price
    
    # 이익 계산
    if current_price > bot_avg_price:
        profit_ratio = (current_price - bot_avg_price) / bot_avg_price
        profit_amount = bot_amount * profit_ratio
        
        # 투자금 + 이익분
        sellable = bot_amount + profit_amount
    else:
        # 손실 시: 투자금만
        sellable = bot_amount
    
    # 안전 제한
    sellable = min(sellable, actual_amount - existing_amount)
    
    return sellable, "투자금 + 이익분 (원금 보호)"
```

### 2. `src/main.py`
```python
# execute_sell() 수정
sellable_amount, sell_msg = self.holding_protector.calculate_sellable_amount(
    ticker,
    current_price=current_price,  # 🆕 현재가 전달
    upbit_api=self.api
)
```

### 3. `src/utils/logger.py`
```python
# 백업 파일 중복 처리
if backup_path.exists():
    backup_path.unlink()  # 🆕 기존 삭제
backup_path.rename(new_path)
```

---

## 🎯 정책 요약

| 항목 | v5.6 | v5.7 | 변경 |
|------|------|------|------|
| 원금 매도 | 가능 ❌ | **불가** ✅ | 보호 강화 |
| 투자금 매도 | 가능 ✅ | 가능 ✅ | 유지 |
| 이익분 매도 | - | **가능** ✅ | 신규 |
| 손실 시 매도 | 전체 | **투자금만** ✅ | 원금 보호 |

---

## 🚀 실행 방법

### 1단계: 최신 코드 받기
```bash
cd Lj-main
git pull origin main
```

**기대 출력**:
```
From https://github.com/lee-jungkil/Lj
   ff2a861..2bc95f6  main       -> origin/main
Updating ff2a861..2bc95f6
Fast-forward
 src/main.py                     | ...
 src/utils/holding_protector.py  | ...
 src/utils/logger.py              | ...
 3 files changed, 54 insertions(+), 18 deletions(-)
```

### 2단계: 모의투자 테스트
```bash
run_paper.bat
```

**정상 동작 확인**:
```
✅ 기존 보유: KRW-BTC | 0.001개 | 평단: 50,000,000원
✅ 코인 개수: 35개 (고정)
✅ 실시간 잔고: 500,000원
```

### 3단계: 실거래 (원금 보호 활성화)
```bash
# .env 수정
TRADING_MODE=live
UPBIT_ACCESS_KEY=your_key
UPBIT_SECRET_KEY=your_secret

# 실행
run_live.bat
```

**실거래 확인**:
```
💰 실시간 잔고: 500,000원
📦 기존 보유: 2개 (원금 보호)
🛡️  원금 보호 활성화
```

### 4단계: 매도 시 확인
```
매수:
✅ KRW-BTC 추가 매수: 0.0005개 (50,000,000원)

매도 (수익):
🛡️  원금 보호: 0.001개 유지
✅ 매도 가능: 0.00055개 (투자금 + 이익)
💰 매도 완료: +50,000원

매도 (손실):
🛡️  원금 보호: 0.001개 유지
✅ 매도 가능: 0.0005개 (투자금만)
📉 매도 완료: -10,000원
```

---

## ⚠️ 주의사항

### 원금 보호 정책
```
✅ DO:
- 기존 보유 코인에 추가 매수
- 투자금 + 이익분 매도
- 손실 시 투자금만 손절

❌ DON'T:
- 원금(기존 보유) 매도 시도
- 원금을 투자금으로 계산
```

### 이익 계산
```
이익 발생 조건:
- 현재가 > 봇 평균 매수가
- 이익분 = 투자금 × 이익률
- 최대 매도 = 투자금 + 이익분

손실 발생 시:
- 투자금만 매도 가능
- 원금은 절대 보호
```

### 안전 장치
```python
# 매도 가능 수량 제한
sellable = min(
    투자금 + 이익분,
    실제 보유 - 원금
)

# 원금 침해 방지
if sellable < 0:
    return 0, "원금 보호"
```

---

## 📈 기대 효과

### 원금 보호
- ✅ 기존 보유 코인 안전
- ✅ 장기 투자 유지 가능
- ✅ 봇 손실과 분리

### 수익 극대화
- ✅ 이익 발생 시 이익분 추가 매도
- ✅ 투자금 회수 + 이익 실현
- ✅ 원금은 계속 보유 (장기 수익)

### 리스크 관리
- ✅ 손실 시 투자금만 손절
- ✅ 원금 손실 방지
- ✅ 자본 보존

---

## 📚 관련 문서
- 📖 **V5.7_POLICY_UPDATE.md** - 이 문서
- 📖 V5.6_EMERGENCY_FIX.md - v5.6 가이드
- 📖 V5.5_COMPLETE_GUIDE.md - v5.5 가이드
- 📖 START_HERE.md - 시작 가이드

---

## ✅ 완료 체크리스트

### 오류 수정
- [x] 거래 로그 WinError 183 수정
- [x] 백업 파일 중복 처리

### 정책 구현
- [x] 원금 보호 (기존 보유 매도 불가)
- [x] 투자금 매도 허용
- [x] 이익분 매도 허용
- [x] 이익률 기반 계산
- [x] 안전장치 추가

### 코드 개선
- [x] HoldingProtector 로직 개선
- [x] current_price 파라미터 추가
- [x] main.py 매도 로직 수정
- [x] logger.py 안전 처리

---

## 🎉 최종 결과

### v5.6 → v5.7 핵심 개선
1. ✅ **원금 보호**: 기존 보유 절대 보호
2. ✅ **이익 최적화**: 투자금 + 이익분 매도
3. ✅ **리스크 관리**: 손실 시 원금 보호
4. ✅ **로그 안정화**: WinError 183 해결

### GitHub 반영 완료 ✅
- **저장소**: https://github.com/lee-jungkil/Lj
- **커밋**: 2bc95f6
- **버전**: v5.7
- **날짜**: 2026-02-11

---

**🔥 지금 바로 `git pull`하여 v5.7을 사용하세요!**  
**원금 보호 + 이익 최적화가 완벽하게 구현되었습니다!** 🎉
