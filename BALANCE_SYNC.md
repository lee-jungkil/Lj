# 💰 잔고 동기화 시스템 가이드

## 🎯 문제 상황

봇이 실행 중일 때 사용자가 직접 업비트에서 입출금을 하면 어떻게 될까요?

### ❌ 기존 방식의 문제점

```
1️⃣ 봇 시작: 초기 자본 500,000원
2️⃣ 사용자가 업비트에 직접 200,000원 추가 입금
3️⃣ 봇의 인식: 여전히 500,000원 (❌ 잘못됨!)
   실제 잔고: 700,000원

결과:
- ❌ 손실 한도 계산 오류
- ❌ 포지션 크기 계산 오류  
- ❌ 수익률 계산 오류
- ❌ 실제 자금과 봇 추적 불일치
```

## ✅ 해결 방법: 자동 잔고 동기화

봇이 **자동으로 업비트 실제 잔고를 조회**하고 내부 잔고와 비교해 동기화합니다.

### 🔄 동기화 시점

1. **매일 자정 (일일 통계 초기화 시)**
   - 매일 첫 거래 전에 자동 동기화
   - 전날 외부 입출금이 있었는지 체크

2. **포지션 크기 계산 시 (강제 동기화 옵션)**
   - 매수 주문 전 최신 잔고 확인
   - `force_sync=True` 파라미터로 강제 동기화 가능

3. **수동 동기화 (필요시)**
   - API를 통해 언제든 수동 호출 가능

### 🔍 동기화 동작 원리

```python
def sync_balance_from_exchange():
    # 1. 업비트에서 실제 잔고 조회
    actual_balance = upbit_api.get_balance('KRW')  # 예: 700,000원
    
    # 2. 봇 추적 잔고와 비교
    bot_balance = self.current_balance  # 예: 500,000원
    
    # 3. 차이 계산
    difference = actual_balance - bot_balance  # 200,000원
    
    # 4. 차이가 1,000원 이상이면 동기화
    if abs(difference) >= 1000:
        print("⚠️ 잔고 불일치 감지!")
        print(f"   봇 추적 잔고: {bot_balance:,.0f}원")
        print(f"   실제 거래소 잔고: {actual_balance:,.0f}원")
        print(f"   차이: {difference:+,.0f}원")
        
        if difference > 0:
            print(f"   → 외부 입금 감지: +{difference:,.0f}원")
        else:
            print(f"   → 외부 출금 감지: {difference:,.0f}원")
        
        # 5. 잔고 동기화
        self.current_balance = actual_balance
        print(f"✅ 잔고 동기화 완료: {actual_balance:,.0f}원\n")
```

## 📊 시나리오별 대응

### 시나리오 1: 추가 입금

```
상황: 
- 봇 실행 중 (현재 잔고: 500,000원)
- 사용자가 업비트에 200,000원 추가 입금

봇의 대응:
1. 다음 동기화 시점에 차이 감지
2. 로그 출력:
   ⚠️ 잔고 불일치 감지!
   봇 추적 잔고: 500,000원
   실제 거래소 잔고: 700,000원
   차이: +200,000원
   → 외부 입금 감지: +200,000원
   ✅ 잔고 동기화 완료: 700,000원

3. 결과:
   ✅ 잔고: 500,000 → 700,000원
   ✅ 포지션 크기 자동 조정 (더 큰 금액 투자 가능)
   ✅ 손실 한도 기준은 유지 (기존 -50,000원)
   ✅ 수익률 계산도 정확히 유지
```

### 시나리오 2: 일부 출금

```
상황:
- 봇 실행 중 (현재 잔고: 500,000원)
- 사용자가 업비트에서 100,000원 출금

봇의 대응:
1. 다음 동기화 시점에 차이 감지
2. 로그 출력:
   ⚠️ 잔고 불일치 감지!
   봇 추적 잔고: 500,000원
   실제 거래소 잔고: 400,000원
   차이: -100,000원
   → 외부 출금 감지: -100,000원
   ✅ 잔고 동기화 완료: 400,000원

3. 결과:
   ✅ 잔고: 500,000 → 400,000원
   ✅ 포지션 크기 자동 감소 (작은 금액 투자)
   ✅ 기존 포지션은 유지
   ✅ 손실 한도는 그대로 유지
```

### 시나리오 3: 월 수익 50% 출금

```
상황:
- 봇이 한 달간 +200,000원 수익
- 월말에 자동으로 50% 출금 알림 (100,000원)
- 사용자가 직접 100,000원 출금

봇의 대응:
1. 월간 수익 체크 (매월 1일)
2. 출금 알림:
   💰 월간 수익: +200,000원
   📤 출금 권장 금액: 100,000원 (50%)
   📈 재투자 금액: 100,000원 (50%)

3. 사용자 출금 후 동기화:
   ✅ 출금 감지 및 동기화
   ✅ 재투자 금액으로 계속 거래
   ✅ 월간 수익 카운터 초기화
```

## 🔧 기술적 세부사항

### 동기화 트리거

```python
# 1. 일일 통계 초기화 시 (매일 자정)
def reset_daily_stats(self):
    today = date.today()
    if today > self.last_reset_date:
        # 자동 동기화
        self.sync_balance_from_exchange()
        
        self.daily_profit_loss = 0.0
        self.last_reset_date = today
        self.is_trading_stopped = False

# 2. 포지션 크기 계산 시 (선택적)
def calculate_position_size(self, price: float, force_sync: bool = False):
    # 필요시 강제 동기화
    if force_sync:
        self.sync_balance_from_exchange()
    
    available_balance = self.current_balance
    max_investment = available_balance * self.max_position_ratio
    return max_investment
```

### 초기 자본 조정 로직

```python
# 잔고 동기화 시 초기 자본도 조정
# 단, 누적 손익은 유지 (실제 거래 성과 추적)
self.initial_capital = actual_balance - self.cumulative_profit_loss

# 예시:
# - 실제 잔고: 700,000원
# - 누적 손익: +50,000원
# - 조정된 초기 자본: 700,000 - 50,000 = 650,000원
# → 수익률 계산: 50,000 / 650,000 = 7.69%
```

### 오차 허용 범위

```python
# 1,000원 이하의 차이는 무시 (수수료/오차 허용)
if abs(balance_diff) >= 1000:
    # 동기화 실행
    sync_balance()
else:
    # 무시 (정상 범위 내 오차)
    pass
```

## 💡 사용 시나리오별 팁

### 초기 자본 확장 (50만원 → 1,000만원)

```bash
# 1단계: 초기 50만원으로 시작
INITIAL_CAPITAL=500000

# 봇이 안정적으로 운영됨을 확인

# 2단계: 추가 자금 입금 (950만원)
# 업비트에서 직접 입금

# 3단계: 봇이 자동 감지 및 동기화
⚠️ 잔고 불일치 감지!
   봇 추적 잔고: 500,000원
   실제 거래소 잔고: 10,000,000원
   차이: +9,500,000원
   → 외부 입금 감지: +9,500,000원
✅ 잔고 동기화 완료: 10,000,000원

# 4단계: 자동으로 포지션 크기 확대
# 30% 최대 비율 유지
# - 이전: 500,000 × 0.3 = 150,000원/포지션
# - 이후: 10,000,000 × 0.3 = 3,000,000원/포지션
```

### 일부 출금 (긴급 자금 필요)

```bash
# 상황: 500,000원 중 200,000원 긴급 출금 필요

# 1단계: 업비트에서 직접 200,000원 출금

# 2단계: 봇이 자동 감지
⚠️ 잔고 불일치 감지!
   → 외부 출금 감지: -200,000원
✅ 잔고 동기화 완료: 300,000원

# 3단계: 포지션 크기 자동 축소
# - 이전: 500,000 × 0.3 = 150,000원/포지션
# - 이후: 300,000 × 0.3 = 90,000원/포지션

# 4단계: 기존 포지션은 유지
# 새 매수만 축소된 크기로 진행
```

### 수익 출금 후 재시작

```bash
# 상황: 월간 수익 200,000원 → 100,000원 출금

# 1단계: 봇 출금 알림 확인
💰 월간 수익: +200,000원
📤 출금 권장 금액: 100,000원 (50%)

# 2단계: 업비트에서 100,000원 출금

# 3단계: 봇이 자동 동기화
✅ 잔고 동기화 완료
✅ 월간 수익 카운터 초기화

# 4단계: 남은 100,000원으로 재투자 계속
```

## ⚙️ 설정 및 제어

### 환경 변수 (.env)

```bash
# 초기 자본 (참고용, 실시간 동기화됨)
INITIAL_CAPITAL=500000

# 손실 한도 (외부 입출금과 무관하게 고정)
MAX_DAILY_LOSS=50000
MAX_CUMULATIVE_LOSS=100000

# 포지션 관리 (잔고에 비례해 자동 조정)
MAX_POSITIONS=3
MAX_POSITION_RATIO=0.3
```

### 동기화 강제 실행

```python
# 메인 루프에서 필요시 강제 동기화
if user_manual_sync_request:
    bot.risk_manager.sync_balance_from_exchange()
```

## 📊 모니터링

### 잔고 추적 로그 확인

```bash
# 거래 로그에서 잔고 변화 추적
cat trading_logs/trade_$(date +%Y%m%d).json | jq '.balance'

# 예시 출력:
500000  # 초기
490000  # 거래 후
700000  # 외부 입금 후 동기화
650000  # 거래 후
```

### 동기화 이벤트 로그

```bash
# 에러 로그에서 동기화 이벤트 확인
grep "잔고 불일치" trading_logs/error_$(date +%Y%m%d).log

# 예시 출력:
2024-02-10 09:00:01 - ⚠️ 잔고 불일치 감지!
2024-02-10 09:00:01 - 외부 입금 감지: +200,000원
2024-02-10 09:00:01 - ✅ 잔고 동기화 완료: 700,000원
```

## 🔒 안전장치

### 1. 손실 한도는 절대 기준 유지

```
외부 입금으로 잔고가 늘어나더라도:
❌ 손실 한도가 비례해서 늘어나지 않음
✅ 고정된 금액으로 유지 (예: -50,000원)

이유:
- 리스크 관리 일관성 유지
- 초보자 보호
- 과도한 손실 방지
```

### 2. 기존 포지션 보호

```
외부 출금으로 잔고가 줄어들어도:
✅ 기존 포지션은 유지
✅ 청산 조건은 변경 없음
❌ 강제 청산하지 않음

새 포지션만 축소된 크기로 진행
```

### 3. 수익률 계산 정확도

```
초기 자본 자동 조정:
- 실제 잔고 = 조정된 초기 자본 + 누적 손익
- 수익률 = 누적 손익 / 조정된 초기 자본

예시:
- 실제 잔고: 700,000원
- 누적 손익: +50,000원  
- 조정된 초기 자본: 650,000원
- 수익률: 7.69% ✅ 정확함
```

## 🎯 결론

### ✅ 자동 잔고 동기화의 장점

1. **외부 입출금 대응**: 사용자가 직접 입출금해도 문제없음
2. **자동 포지션 조정**: 잔고에 맞춰 투자 규모 자동 조정
3. **정확한 손익 추적**: 수익률 계산 정확도 유지
4. **유연한 자금 관리**: 필요시 자금 추가/회수 가능
5. **리스크 일관성**: 손실 한도는 고정 유지

### 📋 권장 사항

- ✅ 매일 자정 자동 동기화 (기본 활성화)
- ✅ 대규모 입출금 전 봇 로그 확인
- ✅ 동기화 이벤트 모니터링
- ⚠️ 포지션 보유 중 출금 시 주의 (청산 불가)
- ⚠️ 손실 한도는 수동 조정 필요 (입금 후 비율 변경 시)

### 🔧 추가 개선 가능성

- [ ] 대규모 입출금 시 텔레그램 알림
- [ ] 입출금 이력 로그 파일 저장
- [ ] 동기화 간격 설정 옵션 (.env)
- [ ] 수동 동기화 명령 인터페이스

---

**관련 문서**:
- `LIVE_TRADING_GUIDE.md` - 실거래 시작 가이드
- `README.md` - 프로젝트 전체 가이드
- `QUICKRUN.md` - 빠른 실행 방법

**GitHub**: https://github.com/lee-jungkil/Lj
**다운로드**: https://github.com/lee-jungkil/Lj/archive/refs/heads/main.zip
