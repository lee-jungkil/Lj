# 🛡️ 기존 보유 코인 보호 시스템

## 🎯 문제 상황

```
현재 상황:
- 기존 보유: DOGE 10,000개 (-90% 손실)
  평균가: 100원 → 현재가: 10원
  투자금: 1,000,000원 → 현재가치: 100,000원

봇 실행 후 우려:
❌ 봇이 DOGE를 매도해버리면?
   → -900,000원 손실 확정!
❌ 기존 코인을 팔고 싶지 않음
   → 회복 기회 박탈!
```

## ✅ 해결 방법

**기존 보유 코인 보호 시스템!**

```
✅ 기존 보유 코인 등록
✅ 봇은 등록된 코인 절대 매도 안 함
✅ 봇이 같은 코인 매수 시: 신규 투자분만 관리
✅ 매도 시: 봇 투자금 + 이익만 매도
✅ 기존 수량 완벽 보호
```

---

## 🚀 빠른 시작 (3단계)

### 1단계: 기존 보유 등록

```bash
cd /home/user/webapp
python register_holdings.py
```

### 2단계: 등록 방법 선택

```
🛡️  기존 보유 코인 보호 시스템 - 등록 도구
═══════════════════════════════════════════════════

💼 현재 보유 중인 코인:
────────────────────────────────────────────────────

KRW-DOGE:
  수량: 10000.00000000
  평균 매수가: 100원
  현재가: 10원
  투자금액: 1,000,000원
  현재가치: 100,000원
  손익: -90.00%
  ⚠️  손실 중!

────────────────────────────────────────────────────
═══════════════════════════════════════════════════
등록 방법:
1. 자동 등록: 현재 보유 중인 모든 코인을 자동 등록
2. 선택 등록: 특정 코인만 선택해서 등록
3. 수동 입력: 티커, 수량, 평균가를 직접 입력
4. 종료
═══════════════════════════════════════════════════

선택 (1-4): 1
```

### 3단계: 봇 실행

```bash
./run.sh
# 모드 선택: live

# 결과
✅ 기존 보유 1개 코인 로드 완료
🛡️  기존 보유 1개 코인 보호 활성화
🤖 봇 가동 시작!
```

---

## 📊 동작 예시

### 시나리오 A: 기존 보유 DOGE, 봇도 DOGE 매수

```
[초기 상태]
기존 보유: DOGE 10,000개 (평균가 100원) ← 보호!
봇 잔고: 500,000원

[봇 매수]
📊 DOGE 매수 신호 발생
💰 매수: DOGE 5,000개 @ 10원 = 50,000원

[결과]
✅ 기존 보유 등록: DOGE 10,000개
   수량: 10,000개
   평균가: 100원
   ⚠️  절대 매도하지 않음!

✅ 봇 포지션 신규 추가: DOGE 5,000개
   수량: 5,000개
   가격: 10원
   ⚠️  주의: 기존 보유 10,000개 보호 중
   → 봇 매수분 5,000개만 별도 관리

💼 업비트 실제 보유: DOGE 15,000개
   = 기존 10,000개 + 봇 5,000개
```

### 시나리오 B: DOGE 가격 상승 후 매도 신호

```
[가격 변동]
DOGE: 10원 → 15원 (+50%)

[봇 매도 신호]
📊 DOGE 매도 신호 발생

[매도 가능 수량 계산]
실제 보유: 15,000개
기존 보유(보호): 10,000개
────────────────────────────────
매도 가능: 5,000개 (봇 투자분만!)

[매도 실행]
🛡️  DOGE 부분 매도: 5,000개 (기존 보유 보호)
💵 매도: DOGE 5,000개 @ 15원 = 75,000원

[손익]
봇 투자: 50,000원
매도 금액: 75,000원
───────────────────────
순이익: +25,000원 ✅

[최종 상태]
✅ 기존 보유 10,000개 보호 완료 (매도하지 않음)
✅ 봇 포지션 전량 청산
💼 업비트 실제 보유: DOGE 10,000개 (기존분만 남음)
💰 봇 잔고: 500,000 - 50,000 + 75,000 = 525,000원
```

---

## 🛡️ 보호 메커니즘

### 1. 분리 추적

```python
기존 보유 (ExistingHolding):
{
  "ticker": "KRW-DOGE",
  "amount": 10000,  # 절대 건드리지 않음!
  "avg_buy_price": 100,
  "note": "자동 등록 (손익: -90.00%)"
}

봇 포지션 (BotPosition):
{
  "ticker": "KRW-DOGE",
  "bot_amount": 5000,  # 봇이 추가 매수한 수량
  "bot_avg_price": 10,
  "bot_investment": 50000  # 봇 투자 금액
}

→ 완전히 분리 관리!
```

### 2. 매도 가능 수량 계산

```python
def calculate_sellable_amount(ticker):
    실제_보유 = upbit.get_amount(ticker)  # 15,000개
    기존_보유 = existing_holdings[ticker]  # 10,000개
    
    매도_가능 = 실제_보유 - 기존_보유  # 5,000개만!
    
    if 매도_가능 < 0:
        return 0  # 보호 대상 침해 방지
    
    return 매도_가능
```

### 3. 안전 검증

```python
if 매도_수량 > 봇_포지션.bot_amount:
    # 과도한 매도 방지
    매도_수량 = 봇_포지션.bot_amount

if 실제_보유 < 기존_보유:
    # 기존 보유량 부족 경고
    return 0, "보호 대상 부족"
```

---

## 📋 등록 방법 상세

### 방법 1: 자동 등록 (권장)

```bash
python register_holdings.py
선택: 1

# 장점
✅ 모든 보유 코인 자동 등록
✅ 빠르고 간편
✅ 실수 없음

# 결과
✅ 기존 보유 등록: KRW-DOGE
   수량: 10000.00000000
   평균가: 100원
   메모: 자동 등록 (손익: -90.00%)

✅ 기존 보유 등록: KRW-XRP
   수량: 50000.00000000
   평균가: 500원
   메모: 자동 등록 (손익: -60.00%)

✅ 총 2개 코인 등록 완료!
```

### 방법 2: 선택 등록

```bash
python register_holdings.py
선택: 2

보유 코인 목록:
1. KRW-DOGE: 10000개 (손익: -90.00%)
2. KRW-XRP: 50000개 (손익: -60.00%)
3. KRW-BTC: 0.01개 (손익: +20.00%)

등록할 코인 번호 (쉼표로 구분, 예: 1,3,5): 1,2

# 손실 코인만 선택 등록
✅ 2개 코인 등록 완료!
```

### 방법 3: 수동 입력

```bash
python register_holdings.py
선택: 3

티커 (예: KRW-BTC): DOGE
수량: 10000
평균 매수가: 100
메모 (선택사항): 회복 대기 중

✅ 등록 완료!
```

---

## 🔍 상태 확인

### 등록 시 자동 출력

```
═══════════════════════════════════════════════════
🛡️  기존 보유 코인 보호 시스템
═══════════════════════════════════════════════════

📦 보호 중인 기존 보유:

  KRW-DOGE:
    수량: 10000.00000000
    평균가: 100원
    현재가: 10원
    현재가치: 100,000원
    손익률: -90.00%
    메모: 자동 등록
    ⚠️  절대 매도하지 않음!

🤖 봇 거래 포지션 (매도 가능):
  (없음)

═══════════════════════════════════════════════════
```

### 봇 실행 중 로그

```
[10:15:30] 📊 DOGE 매수 신호 발생
[10:15:31] ✅ 매수: KRW-DOGE, 50,000원
[10:15:32] 📝 봇 포지션 신규 추가: KRW-DOGE
   수량: 5000.00000000
   가격: 10원
   ⚠️  주의: 기존 보유 10000.00000000개 보호 중
   → 봇 매수분 5000.00000000개만 별도 관리

[10:25:15] 📊 DOGE 매도 신호 발생
[10:25:16] 🛡️  KRW-DOGE 부분 매도: 5000개 (기존 보유 보호)
[10:25:17] 💵 매도: KRW-DOGE, +25,000원
[10:25:18] ✅ 봇 포지션 전량 청산: KRW-DOGE
   매도 수량: 5000.00000000
   매도가: 15원
   손익: +25,000원
[10:25:19] ✅ 기존 보유 10000개 보호 완료 (매도하지 않음)
```

---

## ⚠️ 중요 주의사항

### 1. 등록 타이밍

```
✅ 좋은 타이밍:
- 봇 실행 전
- 손실 코인이 있을 때
- 장기 보유 계획이 있을 때

❌ 나쁜 타이밍:
- 봇이 이미 해당 코인을 매수한 후
- 등록하지 않고 봇 실행 → 기존 코인 매도됨!
```

### 2. 등록 후 확인

```bash
# 파일 확인
cat trading_logs/existing_holdings.json

{
  "holdings": {
    "KRW-DOGE": {
      "ticker": "KRW-DOGE",
      "amount": 10000.0,
      "avg_buy_price": 100.0,
      ...
    }
  }
}
```

### 3. 등록 해제

```bash
# 파일 수정 또는 삭제
vi trading_logs/existing_holdings.json

# 특정 코인만 제거
# "KRW-DOGE" 항목 삭제

# 전체 초기화
rm trading_logs/existing_holdings.json
```

---

## 🎓 실전 시나리오

### Case 1: -90% 손실 DOGE 보호

```
상황:
- DOGE 10,000개 보유
- 평균가 100원 → 현재가 10원
- 손실 -900,000원 (-90%)

목표:
- 회복 기회 유지
- 추가 하락 방지

해결:
1. DOGE 등록 (보호)
2. 봇 실행
3. 봇이 DOGE 추가 매수/매도 가능
4. 기존 10,000개는 절대 안전

결과:
✅ 기존 보유 보호
✅ 봇으로 추가 수익
✅ 회복 기회 유지
```

### Case 2: 여러 손실 코인 보호

```
보유 현황:
- DOGE: -90% (1,000,000원 → 100,000원)
- XRP: -60% (500,000원 → 200,000원)
- ADA: -50% (300,000원 → 150,000원)

해결:
1. 3개 전부 등록
2. 봇 실행 (다른 코인 거래)
3. 우연히 봇이 DOGE 매수 시
   → 봇 투자분만 관리

결과:
✅ 3개 전부 보호
✅ 회복 대기 중
✅ 봇은 자유롭게 거래
```

### Case 3: 부분 회복 후 정리

```
초기:
- DOGE 10,000개 (평균가 100원)
- 현재가 10원 (-90%)

3개월 후:
- 현재가 70원 (-30%)
- 많이 회복됨!

결정:
- 기존 보유 매도하고 싶음
- 등록 해제 필요

해결:
1. trading_logs/existing_holdings.json에서 DOGE 삭제
2. 봇 재시작
3. 다음 매도 신호 시 전량 매도 가능

결과:
✅ 부분 회복 성공
✅ 손실 -30%로 최소화
```

---

## 💾 데이터 저장

### 파일 위치

```
trading_logs/existing_holdings.json
```

### 파일 구조

```json
{
  "holdings": {
    "KRW-DOGE": {
      "ticker": "KRW-DOGE",
      "amount": 10000.0,
      "avg_buy_price": 100.0,
      "current_value": 100000.0,
      "loss_ratio": -90.0,
      "lock_date": "2024-02-10T12:00:00",
      "note": "자동 등록 (손익: -90.00%)"
    }
  },
  "updated_at": "2024-02-10T12:00:00"
}
```

### 백업 권장

```bash
# 백업
cp trading_logs/existing_holdings.json existing_holdings_backup.json

# 복원
cp existing_holdings_backup.json trading_logs/existing_holdings.json
```

---

## 🔗 관련 파일

| 파일 | 역할 |
|------|------|
| `src/utils/holding_protector.py` | 보호 시스템 엔진 |
| `register_holdings.py` | 등록 도구 |
| `trading_logs/existing_holdings.json` | 저장 데이터 |

---

## ✅ 체크리스트

봇 실행 전:
- [ ] 손실 코인 확인
- [ ] `python register_holdings.py` 실행
- [ ] 등록 완료 확인
- [ ] `existing_holdings.json` 파일 생성 확인
- [ ] 봇 실행 시 "기존 보유 로드" 메시지 확인

---

## 🎉 결론

### 핵심 기능

✅ **기존 손실 코인 완벽 보호**
✅ **봇 투자분만 분리 관리**
✅ **매도 시 봇 투자금 + 이익만**
✅ **기존 수량 절대 보존**
✅ **회복 기회 유지**

### 안심하고 사용하세요!

```
기존 보유: 절대 안전 🛡️
봇 거래: 자유롭게 ✅
손실 최소화: 가능 📈
회복 기회: 유지 💪
```

**손실 코인을 보호하면서 봇으로 수익을 내세요!** 🚀

---

**GitHub**: https://github.com/lee-jungkil/Lj  
**다운로드**: https://github.com/lee-jungkil/Lj/archive/refs/heads/main.zip
