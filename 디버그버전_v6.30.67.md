# 🔍 디버그 버전 v6.30.67 - 매도 실패 원인 추적

**날짜**: 2026-02-15  
**버전**: `v6.30.67-DEBUG-LOGGING`  
**목적**: 매도가 실행되지 않는 **정확한 위치** 찾기

---

## 🎯 **이 버전의 목적**

사용자님의 로그에서:
```
[FORCE-SELL] execute_sell() 호출
[FORCE-SELL] ✅ 포지션 찾음
(그 이후 아무 로그도 없음)
```

**문제:** 어디서 멈추는지 알 수 없음!

**해결:** 모든 단계마다 로그 추가 → **어디서 멈추는지 정확히 파악**

---

## 🆕 **추가된 로그 (총 15개 이상)**

### **1단계: 가격 조회**
```
[EXECUTE-SELL] 현재가 조회 시작...
[EXECUTE-SELL] 가격 조회 시도 1/3...
[EXECUTE-SELL] 가격 조회 결과: 1234.56
```
**또는 실패 시:**
```
[EXECUTE-SELL] 가격 조회 예외: ...
[EXECUTE-SELL] ❌ 가격 조회 실패 - 평균 매수가로 대체
```

### **2단계: 손익률 계산**
```
[EXECUTE-SELL] 손익률 계산 중...
[EXECUTE-SELL] 손익률: +2.50%
```

### **3단계: ExitReason 파싱**
```
[EXECUTE-SELL] ExitReason 파싱 중...
[EXECUTE-SELL] ExitReason: VOLUME_DROP
```

### **4단계: 스프레드 분석**
```
[EXECUTE-SELL] 스프레드 분석 중...
[EXECUTE-SELL] 스프레드: 0.15%
```
**또는 실패 시:**
```
[EXECUTE-SELL] 스프레드 계산 실패: ..., 기본값 0.1 사용
```

### **5단계: 시장 조건 분석**
```
[EXECUTE-SELL] 시장 조건 분석 중...
[EXECUTE-SELL] 시장 조건: {'volatility': 'medium', 'trend': 'neutral'}
```
**또는 실패 시:**
```
[EXECUTE-SELL] 시장 조건 분석 실패: ..., 기본값 사용
```

### **6단계: 주문 방법 선택**
```
[EXECUTE-SELL] 주문 방법 선택 중...
[EXECUTE-SELL] 주문 방법: market, 이유: high_volatility
```
**또는 실패 시:**
```
[EXECUTE-SELL] 주문 방법 선택 실패: ..., 시장가 주문 사용
```

### **7단계: 포지션 청산 (기존)**
```
[EXECUTE-SELL] 모의거래 모드: 포지션 전체 매도 허용
[EXECUTE-SELL] ========== Position cleanup start ==========
...
```

---

## 🔧 **핵심 수정 사항**

### **1. 가격 조회 실패 시 early return 제거**

**이전 (v6.30.66):**
```python
if not current_price:
    log_error(...)
    return  # ⚠️ 포지션 갇힘!
```

**이후 (v6.30.67):**
```python
if not current_price:
    log_error(...)
    current_price = position.avg_buy_price  # ✅ 평균가로 대체
    # 청산은 계속 진행!
```

### **2. 모든 위험 구간에 fallback 추가**

| 단계 | 실패 시 동작 | 결과 |
|------|------------|------|
| 가격 조회 | 평균 매수가 사용 | ✅ 청산 진행 |
| 스프레드 계산 | 0.1 사용 | ✅ 청산 진행 |
| 시장 조건 분석 | medium/neutral 사용 | ✅ 청산 진행 |
| 주문 방법 선택 | market 사용 | ✅ 청산 진행 |

**보장:** 어떤 단계가 실패해도 **청산 코드까지 도달**

---

## 📥 **업데이트 방법**

### **방법 1: 빠른 업데이트**

```batch
@echo off
cd C:\Users\admin\Downloads\Lj-main\Lj-main

echo 1. Stopping Python...
taskkill /F /IM python.exe /T 2>nul
timeout /t 2 /nobreak > nul

echo 2. Clearing cache...
del /s /q *.pyc 2>nul
for /d /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d" 2>nul

echo 3. Downloading v6.30.67...
powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/lee-jungkil/Lj/main/src/main.py' -OutFile 'src\main.py' -UseBasicParsing"
powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/lee-jungkil/Lj/main/VERSION.txt' -OutFile 'VERSION.txt' -UseBasicParsing"

echo 4. Verifying...
type VERSION.txt
findstr /C:"현재가 조회 시작" src\main.py >nul
if %errorlevel% EQU 0 (
    echo ✅ v6.30.67 verified!
) else (
    echo ❌ Update failed!
    pause
    exit /b 1
)

echo 5. Starting bot...
python -B -u -m src.main --mode paper

pause
```

위 내용을 `UPDATE_v6.30.67.bat`로 저장하고 **관리자 권한**으로 실행하세요.

---

### **방법 2: 수동 업데이트**

```batch
# CMD 관리자

cd C:\Users\admin\Downloads\Lj-main\Lj-main

# 1. 봇 종료
taskkill /F /IM python.exe /T

# 2. 캐시 삭제
del /s /q *.pyc
for /d /r . %d in (__pycache__) do @if exist "%d" rd /s /q "%d"

# 3. 최신 코드
powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/lee-jungkil/Lj/main/src/main.py' -OutFile 'src\main.py' -UseBasicParsing"
powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/lee-jungkil/Lj/main/VERSION.txt' -OutFile 'VERSION.txt' -UseBasicParsing"

# 4. 확인
type VERSION.txt
# v6.30.67-DEBUG-LOGGING

# 5. 시작
python -B -u -m src.main --mode paper
```

---

## 🔍 **매도 시 확인할 로그**

봇을 실행하고 매도가 발생하면, 다음 로그를 **캡처**해주세요:

### **예상 로그 1: 정상 실행**
```
[FORCE-SELL] execute_sell() 호출 - ticker: KRW-XXX
[EXECUTE-SELL] execute_sell() 호출됨
[EXECUTE-SELL] ✅ 포지션 찾음
[EXECUTE-SELL] 현재가 조회 시작...
[EXECUTE-SELL] 가격 조회 시도 1/3...
[EXECUTE-SELL] 가격 조회 결과: 1234.56
[EXECUTE-SELL] 손익률 계산 중...
[EXECUTE-SELL] 손익률: +2.50%
[EXECUTE-SELL] ExitReason 파싱 중...
[EXECUTE-SELL] ExitReason: VOLUME_DROP
[EXECUTE-SELL] 스프레드 분석 중...
[EXECUTE-SELL] 스프레드: 0.15%
[EXECUTE-SELL] 시장 조건 분석 중...
[EXECUTE-SELL] 시장 조건: {'volatility': 'medium', ...}
[EXECUTE-SELL] 주문 방법 선택 중...
[EXECUTE-SELL] 주문 방법: market, 이유: ...
[EXECUTE-SELL] 모의거래 모드: 포지션 전체 매도 허용
[EXECUTE-SELL] ========== Position cleanup start ==========
...
```

### **예상 로그 2: 어딘가에서 멈춤**
```
[FORCE-SELL] execute_sell() 호출 - ticker: KRW-XXX
[EXECUTE-SELL] execute_sell() 호출됨
[EXECUTE-SELL] ✅ 포지션 찾음
[EXECUTE-SELL] 현재가 조회 시작...
[EXECUTE-SELL] 가격 조회 시도 1/3...
(여기서 멈춤)
```

**→ 이 경우 `get_current_price()` API가 무한 대기 중!**

### **예상 로그 3: 예외 발생**
```
[FORCE-SELL] execute_sell() 호출 - ticker: KRW-XXX
[EXECUTE-SELL] execute_sell() 호출됨
[EXECUTE-SELL] ✅ 포지션 찾음
[EXECUTE-SELL] 현재가 조회 시작...
[EXECUTE-SELL] 가격 조회 시도 1/3...
[EXECUTE-SELL] 가격 조회 예외: KeyError: 'close'
[EXECUTE-SELL] 가격 조회 시도 2/3...
[EXECUTE-SELL] 가격 조회 예외: KeyError: 'close'
[EXECUTE-SELL] 가격 조회 시도 3/3...
[EXECUTE-SELL] 가격 조회 예외: KeyError: 'close'
[EXECUTE-SELL] ❌ 가격 조회 실패 - 평균 매수가로 대체
[EXECUTE-SELL] 손익률 계산 중...
...
```

**→ 이 경우에도 청산은 계속 진행됨!**

---

## 📊 **진단 가이드**

| 마지막 로그 | 문제 위치 | 해결 방법 |
|-----------|----------|----------|
| "현재가 조회 시작" | `get_current_price()` 무한 대기 | API 타임아웃 설정 필요 |
| "가격 조회 시도 3/3" 후 멈춤 | 가격 조회 반복 실패 | 네트워크/API 문제 |
| "손익률 계산 중" | 계산 오류 | 코드 수정 필요 |
| "ExitReason 파싱 중" | ExitReason import 실패 | 모듈 누락 |
| "스프레드 분석 중" | API 오류 | Fallback으로 진행됨 |
| "시장 조건 분석 중" | OHLCV 조회 실패 | Fallback으로 진행됨 |
| "주문 방법 선택 중" | `order_method_selector` 오류 | Fallback으로 진행됨 |

---

## ✅ **다음 단계**

1. **v6.30.67로 업데이트**
2. **봇 실행**
3. **매도 발생 시 로그 캡처** (스크린샷)
4. **어디서 멈추는지 확인**
5. **로그 공유** → 정확한 해결책 제시

---

## 📥 **다운로드 링크**

- **main.py**: https://raw.githubusercontent.com/lee-jungkil/Lj/main/src/main.py
- **VERSION.txt**: https://raw.githubusercontent.com/lee-jungkil/Lj/main/VERSION.txt
- **전체 ZIP**: https://github.com/lee-jungkil/Lj/archive/refs/heads/main.zip

---

## 🎯 **기대 효과**

✅ **어디서 멈추는지 정확히 알 수 있음**  
✅ **예외 발생해도 청산은 진행됨**  
✅ **가격 조회 실패해도 평균가로 청산**  
✅ **모든 단계에 fallback 있음**

**이제 매도 시 로그를 캡처해주시면, 정확한 원인을 찾을 수 있습니다!**

---

**버전**: v6.30.67-DEBUG-LOGGING  
**상태**: ✅ DIAGNOSTIC - 문제 위치 추적용  
**GitHub**: https://github.com/lee-jungkil/Lj
