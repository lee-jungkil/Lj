# 💰 잔고 동기화 시스템 - 빠른 참고 가이드

## 🎯 핵심 개념

봇이 실행 중일 때 **업비트에 직접 입출금**을 해도 자동으로 감지하고 동기화합니다!

## ✨ 주요 기능

### 1️⃣ 자동 감지
```
사용자가 직접:
- 업비트에 200만원 추가 입금 → ✅ 자동 감지
- 업비트에서 50만원 출금 → ✅ 자동 감지
- 수익금 일부 출금 → ✅ 자동 감지
```

### 2️⃣ 자동 조정
```
입금 후:
✅ 포지션 크기 자동 증가
✅ 투자 규모 확대
✅ 수익률 정확히 유지

출금 후:
✅ 포지션 크기 자동 감소
✅ 기존 포지션은 유지
✅ 리스크는 그대로 유지
```

### 3️⃣ 실시간 동기화
```
동기화 시점:
- 매일 자정 (자동)
- 포지션 크기 계산 시 (선택)
- 수동 호출 (필요시)
```

## 📊 시나리오별 예시

### 💵 추가 입금 (50만원 → 70만원)

```bash
# 1. 업비트에 20만원 입금

# 2. 봇 자동 감지 (다음 동기화 시)
⚠️ 잔고 불일치 감지!
   봇 추적 잔고: 500,000원
   실제 거래소 잔고: 700,000원
   차이: +200,000원
   → 외부 입금 감지: +200,000원
✅ 잔고 동기화 완료: 700,000원

# 3. 포지션 크기 자동 조정
# 이전: 500,000 × 0.3 = 150,000원/포지션
# 이후: 700,000 × 0.3 = 210,000원/포지션
```

### 💸 일부 출금 (50만원 → 40만원)

```bash
# 1. 업비트에서 10만원 출금

# 2. 봇 자동 감지
⚠️ 잔고 불일치 감지!
   → 외부 출금 감지: -100,000원
✅ 잔고 동기화 완료: 400,000원

# 3. 포지션 크기 자동 축소
# 이전: 500,000 × 0.3 = 150,000원/포지션
# 이후: 400,000 × 0.3 = 120,000원/포지션
# ✅ 기존 포지션은 유지됨
```

### 🎯 자본 확장 (50만원 → 1천만원)

```bash
# 1. 봇 안정성 확인 후 950만원 입금

# 2. 자동 동기화
✅ 잔고: 500,000 → 10,000,000원
✅ 포지션 크기: 150,000 → 3,000,000원
✅ 손실 한도: 여전히 -50,000원 (안전)
✅ 수익률 계산: 정확히 유지
```

## 🔒 안전장치

### ✅ 유지되는 것
- **손실 한도**: 입금해도 -5만원 고정
- **리스크 정책**: 손실 비율 동일 유지
- **기존 포지션**: 출금해도 보호
- **수익률 추적**: 정확한 성과 계산

### ⚙️ 조정되는 것
- **포지션 크기**: 잔고에 비례 조정
- **투자 규모**: 자동 확대/축소
- **거래 가능 금액**: 실시간 반영

## 🔍 동작 확인

### 로그 확인
```bash
# 잔고 동기화 이벤트 확인
tail -f trading_logs/error_$(date +%Y%m%d).log | grep "잔고"

# 출력 예시:
⚠️ 잔고 불일치 감지!
   봇 추적 잔고: 500,000원
   실제 거래소 잔고: 700,000원
   차이: +200,000원
   → 외부 입금 감지: +200,000원
✅ 잔고 동기화 완료: 700,000원
```

### 테스트 확인
```bash
# 잔고 동기화 테스트 실행
cd /home/user/webapp
python -m pytest tests/test_bot.py::TestRiskManager::test_balance_sync_deposit -v

# 모든 동기화 테스트 실행
python -m pytest tests/test_bot.py::TestRiskManager -v -k "sync"
```

## ⚠️ 주의사항

### 1. 포지션 보유 중 출금
```
❌ 나쁜 예:
- 포지션 3개 보유 (총 150만원)
- 잔고에 10만원만 남음
- 전체 출금 시도
→ 청산 불가!

✅ 좋은 예:
- 포지션 청산 후 출금
- 또는 여유 자금만 출금
```

### 2. 손실 한도 조정
```
50만원 → 1천만원 확장 시:

❌ 자동 조정 안 됨:
- 손실 한도: -50,000원 (동일)

✅ 수동 조정 권장:
.env 파일에서:
MAX_DAILY_LOSS=1000000  # 1% = 10만원
MAX_CUMULATIVE_LOSS=2000000  # 2% = 20만원
```

### 3. 작은 차이는 무시
```
1000원 미만 차이:
- 수수료 오차
- 호가 단위 차이
→ 동기화 안 함 (정상)

1000원 이상 차이:
- 실제 입출금으로 판단
→ 동기화 실행
```

## 🎓 실전 활용 팁

### 💡 Tip 1: 단계적 자본 확장
```bash
# 1단계: 50만원으로 1주일 테스트
INITIAL_CAPITAL=500000

# 2단계: 안정성 확인 후 200만원 추가
# → 업비트 입금 후 자동 동기화

# 3단계: 수익 확인 후 500만원 추가
# → 손실 한도 조정 (.env)

# 4단계: 최종 1천만원 확장
# → 전략별 가중치 재조정
```

### 💡 Tip 2: 월간 수익 출금 자동화
```bash
# 매월 1일 자동 알림:
💰 월간 수익: +200,000원
📤 출금 권장 금액: 100,000원 (50%)

# 수동 출금 후:
✅ 자동 동기화
✅ 재투자 금액으로 계속 운영
```

### 💡 Tip 3: 긴급 자금 필요 시
```bash
# 1. 현재 포지션 확인
cat trading_logs/trade_$(date +%Y%m%d).json | jq '.positions'

# 2. 여유 자금 확인
# 잔고 - (포지션 총액)

# 3. 여유 자금만 출금
# → 봇이 자동으로 축소 운영

# 4. 자금 복귀 시 재입금
# → 봇이 자동으로 확대 운영
```

## 📚 더 자세한 내용

- **완전 가이드**: `BALANCE_SYNC.md`
- **실거래 시작**: `LIVE_TRADING_GUIDE.md`
- **빠른 실행**: `QUICKRUN.md`
- **프로젝트 전체**: `README.md`

## 🔗 링크

- **GitHub**: https://github.com/lee-jungkil/Lj
- **다운로드**: https://github.com/lee-jungkil/Lj/archive/refs/heads/main.zip

---

## ✅ 핵심 요약

```
봇 실행 중 직접 입출금 가능! ✅
자동으로 감지하고 조정됨 ✅
포지션 크기 자동 조절 ✅
손실 한도는 고정 유지 ✅
수익률 정확히 추적 ✅
```

**궁금한 점이 있으시면 언제든 물어보세요!** 🙂
